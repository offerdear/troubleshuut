<!DOCTYPE html>
<html>
<head>
    <title>Product Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-dots {
            display: inline-block;
        }
        .dot {
            opacity: 0;
            animation: dot 1.4s infinite;
            animation-fill-mode: both;
        }
        .dot:nth-child(1) { animation-delay: 0s; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes dot {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        .category-button {
            transition: all 0.3s ease;
        }
        
        .category-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Chat modal animations */
        #chat-overlay {
            background: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        
        #chat-modal {
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        #chat-overlay:not(.hidden) #chat-modal {
            transform: translateY(0);
            opacity: 1;
        }
        
        #chat-modal.closing {
            transform: translateY(20px);
            opacity: 0;
        }
        
        /* Chat toggle button */
        #chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50">
    {% include "navbar.html" %}
    <div class="container mx-auto px-4 py-2 mt-4">
        <nav class="flex justify-end">
            <button id="back-btn" class="hidden text-gray-600 px-4 py-2 rounded-lg hover:shadow-lg transition-colors mt-4">
                ‚Üê Back to Store
            </button>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <!-- Storefront View -->
        <div id="storefront-view">
            <!-- Search and Filters -->
            <div class="mb-8 bg-white p-6 rounded-lg shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search Products</label>
                        <input type="text" id="search-input" placeholder="Search by name or brand..." 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Brand</label>
                        <select id="brand-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All Brands</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Category</label>
                        <select id="category-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Product Count -->
            <div class="mb-4">
                <p id="product-count" class="text-gray-600 text-sm"></p>
            </div>

            <!-- Loading State -->
            <div id="loading" class="text-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-4 text-gray-600">Loading products...</p>
            </div>

            <!-- No Results -->
            <div id="no-results" class="text-center py-12 hidden">
                <p class="text-gray-500 text-lg">No products found matching your criteria.</p>
            </div>

            <!-- Products Grid -->
            <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 hidden"></div>
        </div>

        <!-- Product Detail View -->
        <div id="product-view" class="hidden">
            <div id="product-detail" class="bg-white rounded-lg shadow-sm">
                <!-- Product details will be inserted here -->
            </div>
        </div>
    </main>

    <!-- Chat Toggle Button -->
    <div id="chat-toggle" class="fixed bottom-6 right-6 z-40">
        <button id="chat-toggle-btn" class="chat-toggle bg-sky-600 hover:bg-sky-700 text-white p-4 rounded-full shadow-lg flex items-center justify-center">
            <!-- Chat Icon -->
            <svg id="chat-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
        </button>
    </div>

    <!-- Chat Modal Overlay -->
    <div id="chat-overlay" class="hidden fixed inset-0 z-50 modal-overlay bg-black bg-opacity-50">
        <div class="flex items-end justify-end h-full p-4">
            <div id="chat-modal" class="chat-modal bg-white rounded-lg shadow-2xl w-full max-w-md h-full max-h-200 flex flex-col">
                <!-- Chat Header -->
                <div class="bg-blue-600 text-white p-4 rounded-t-lg flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold">Product Support</h3>
                        <p class="text-blue-100 text-sm">How can we help you today?</p>
                    </div>
                    <button id="close-chat" class="text-white hover:text-blue-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Chat Content -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <!-- Messages Area -->
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                        <div class="bg-slate-100 mr-3 p-3 rounded-lg">
                            <p class="mt-1"><strong class="text-slate-700">Assistant:</strong> Welcome! 
                                I'm here to help you with any questions about our products. 
                                Please choose a category to get started, or ask me anything directly!
                            </p>
                            <div id="initial-categories" class="mt-3 space-y-2">
                                <div class="text-center text-gray-500 py-4">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div>
                                    <p class="mt-2 text-sm">Loading categories...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message Input Area -->
                    <div class="p-4 border-t bg-white">
                        <div class="flex space-x-2">
                            <input type="text" id="user-input" 
                                   class="flex-1 border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-sky-500 focus:border-transparent" 
                                   placeholder="Type your message...">
                            <button onclick="sendMessage()" 
                                    class="bg-sky-600 hover:bg-sky-500 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Existing storefront variables
        let allProducts = [];
        let filteredProducts = [];
        let brands = new Set();
        let categories = new Set();
        let currentProduct = null;

        // Enhanced chatbot variables
        let chatCategories = [];
        let chatBrands = new Map(); // Map of category -> brands
        let selectedCategory = '';
        let selectedBrand = '';
        let isChatOpen = false;
        let chatInitialized = false;

        // DOM elements
        const searchInput = document.getElementById('search-input');
        const brandFilter = document.getElementById('brand-filter');
        const categoryFilter = document.getElementById('category-filter');
        const productsGrid = document.getElementById('products-grid');
        const loading = document.getElementById('loading');
        const noResults = document.getElementById('no-results');
        const productCount = document.getElementById('product-count');
        const storefrontView = document.getElementById('storefront-view');
        const productView = document.getElementById('product-view');
        const productDetail = document.getElementById('product-detail');
        const backBtn = document.getElementById('back-btn');

        // Chat elements
        const chatToggle = document.getElementById('chat-toggle');
        const chatToggleBtn = document.getElementById('chat-toggle-btn');
        const chatOverlay = document.getElementById('chat-overlay');
        const chatModal = document.getElementById('chat-modal');
        const closeChatBtn = document.getElementById('close-chat');
        const chatIcon = document.getElementById('chat-icon');
        const closeIcon = document.getElementById('close-icon');
        const userInput = document.getElementById('user-input');

        // Load and parse CSV data
        async function loadProducts() {
            try {
                const response = await fetch('/products.csv');
                const csvText = await response.text();
                
                // Parse the CSV data
                const products = parseCSV(csvText);
                
                allProducts = products;
                filteredProducts = [...allProducts];
                
                // Extract unique brands and categories
                products.forEach(product => {
                    if (product.Brand) brands.add(product.Brand);
                    if (product.Category) categories.add(product.Category);
                });
                
                // Populate filter dropdowns
                populateFilters();
                
                // Display products
                displayProducts();
                
                // Hide loading, show grid
                loading.style.display = 'none';
                productsGrid.style.display = 'grid';
                
                updateProductCount();
                
                // Check if we should show a specific product from URL
                checkForProductInURL();

                // Initialize chatbot once for the entire application
                if (!chatInitialized) {
                    initializeChatbot();
                    chatInitialized = true;
                }
                
            } catch (error) {
                console.error('Error loading products:', error);
                loading.innerHTML = '<div class="text-red-600">Error loading products. Please try again.</div>';
            }
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            const products = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(',').map(v => v.trim());
                const product = {};
                
                headers.forEach((header, index) => {
                    product[header] = values[index] || '';
                });
                
                // Generate a unique ID for each product
                product.id = generateProductId(product.Product_Name.replace(/"/g, ''), product.Brand);
                
                products.push(product);
            }
            
            return products;
        }

        // Generate product ID from name and brand
        function generateProductId(name, brand) {
            return (name + '-' + brand).toLowerCase()
                .replace(/[^a-z0-9]/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');
        }

        // Populate filter dropdowns
        function populateFilters() {
            const sortedBrands = Array.from(brands).sort();
            sortedBrands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandFilter.appendChild(option);
            });

            const sortedCategories = Array.from(categories).sort();
            sortedCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }

        // Display products
        function displayProducts() {
            productsGrid.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                productsGrid.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            productsGrid.style.display = 'grid';
            
            filteredProducts.forEach(product => {
                const productCard = createProductCard(product);
                productsGrid.appendChild(productCard);
            });
        }

        // Create product card
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card bg-white rounded-lg shadow-md p-6 border border-gray-200 hover:shadow-lg transition-shadow cursor-pointer';
            
            card.innerHTML = `
                <div class="text-center">
                    <div class="w-60 h-40 bg-gray-200 mx-auto mb-4 flex items-center justify-center overflow-hidden">
                        <img src="/static/${product.Image_URL}" alt="${product.Short_Description}">
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100 text-left flex flex-col h-40">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2 line-clamp-2">${product.Product_Name.replace(/"/g, '') || 'Unknown Product'}</h3>
                        ${product.Price ? `
                            <div class="flex-1 flex flex-col justify-end mb-2">
                                <p class="text-stone-600">${product.Price}</p>
                            </div>
                        ` : ''}
                        <div class="flex space-x-2 mt-auto">
                            <p class="text-sky-800 font-small">${product.Brand || 'Unknown Brand'}  
                                &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;${product.Category || 'Uncategorized'}
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click event to show product details
            card.addEventListener('click', () => showProduct(product.id));
            
            return card;
        }

        // Show individual product page
        function showProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            currentProduct = product;
            
            // Update URL without page reload
            const newUrl = `${window.location.pathname}?product=${productId}`;
            window.history.pushState({ productId }, '', newUrl);
            
            // Create product detail view
            productDetail.innerHTML = createProductDetailHTML(product);
            
            // Switch views
            storefrontView.style.display = 'none';
            productView.style.display = 'block';
            backBtn.style.display = 'block';
            
            // Update page title
            document.title = `${product.Product_Name.replace(/"/g, '')} - Product Store`;
        }

        // Create product detail HTML
        function createProductDetailHTML(product) {
            return `
                <div class="md:flex">
                    <div class="md:w-1/2 p-8">
                        <div class="w-64 h-64 bg-gray-200 rounded-lg mx-auto flex items-center justify-center mb-6">
                            <img src="/static/${product.Image_URL}" alt="${product.Short_Description}" class="w-full h-full object-cover rounded-lg">
                        </div>
                    </div>
                    <div class="md:w-1/2 p-8">
                        <h1 class="text-3xl font-semibold text-gray-800 mb-4">${product.Product_Name.replace(/"/g, '')}</h1>
                        <p class="text-xl text-stone-600 font-semibold mb-4">${product.Brand}</p>
                        <br><br>
                        ${product.Price ? `<p class="text-xl text-zinc-600 mb-6">${product.Price}</p>` : ''}
                        
                        ${product.Description ? `
                            <div class="mb-8">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">Description</h3>
                                <p class="text-gray-600 leading-relaxed">${product.Description}</p>
                            </div>
                        ` : ''}
                        
                        <div class="space-y-3">
                            <button class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                                Add to Cart
                            </button>
                            <button class="w-full border border-gray-300 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-50 transition-colors">
                                Save for Later
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Go back to storefront
        function goBackToStorefront() {
            storefrontView.style.display = 'block';
            productView.style.display = 'none';
            backBtn.style.display = 'none';
            currentProduct = null;
            
            // Close chat if open
            if (isChatOpen) {
                closeChat();
            }
            
            // Update URL and title
            window.history.pushState({}, '', window.location.pathname);
            document.title = 'Product Store';
        }

        // Check URL for product parameter
        function checkForProductInURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('product');
            if (productId) {
                showProduct(productId);
            }
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.productId) {
                showProduct(event.state.productId);
            } else {
                goBackToStorefront();
            }
        });

        // Filter products
        function filterProducts() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedBrandFilter = brandFilter.value;
            const selectedCategory = categoryFilter.value;
            
            filteredProducts = allProducts.filter(product => {
                const matchesSearch = !searchTerm || 
                    (product.Product_Name && product.Product_Name.toLowerCase().includes(searchTerm)) ||
                    (product.Brand && product.Brand.toLowerCase().includes(searchTerm));
                
                const matchesBrand = !selectedBrandFilter || product.Brand === selectedBrandFilter;
                const matchesCategory = !selectedCategory || product.Category === selectedCategory;
                
                return matchesSearch && matchesBrand && matchesCategory;
            });
            
            displayProducts();
            updateProductCount();
        }

        // Update product count
        function updateProductCount() {
            const total = allProducts.length;
            const showing = filteredProducts.length;
            
            if (showing === total) {
                productCount.textContent = `Showing all ${total} products`;
            } else {
                productCount.textContent = `Showing ${showing} of ${total} products`;
            }
        }

        // =================== ENHANCED CHATBOT FUNCTIONALITY ===================

        // Initialize chatbot
        async function initializeChatbot() {
            try {
                await loadChatCategories();
                setupChatEventListeners();
                
                // Auto-select category if current product has a category
                if (currentProduct && currentProduct.Category) {
                    autoSelectProductCategory();
                }
            } catch (error) {
                console.error('Failed to initialize chatbot:', error);
                addMessage('System', 'Failed to load product categories. Please refresh the page.');
            }
        }

        // Auto-select category based on current product
        function autoSelectProductCategory() {
            if (currentProduct && currentProduct.Category) {
                const productCategory = currentProduct.Category;
                if (chatCategories.includes(productCategory)) {
                    setTimeout(() => {
                        addMessage('Assistant', `I notice you're viewing a ${productCategory} product. I can help you with any questions about it! Please select ${productCategory} from the categories above to get started.`);
                    }, 1000);
                }
            }
        }

        // Load categories and build brand mapping for chatbot
        async function loadChatCategories() {
            try {
                // Use existing categories and brands from products data
                chatCategories = Array.from(categories);
                
                // Build brand mapping by category
                chatBrands.clear();
                allProducts.forEach(product => {
                    if (product.Category && product.Brand) {
                        if (!chatBrands.has(product.Category)) {
                            chatBrands.set(product.Category, new Set());
                        }
                        chatBrands.get(product.Category).add(product.Brand);
                    }
                });
                
                // Update initial category buttons
                displayInitialChatCategories();
                
            } catch (error) {
                console.error('Error loading chat categories:', error);
                throw error;
            }
        }

        // Display initial category selection buttons in chat
        function displayInitialChatCategories() {
            const initialCategoriesDiv = document.getElementById('initial-categories');
            
            if (chatCategories.length === 0) {
                initialCategoriesDiv.innerHTML = '<p class="text-red-500 text-center">No categories available</p>';
                return;
            }

            const colors = ['sky', 'emerald', 'indigo', 'stone', 'rose', 'amber', 'red', 'lime', 'orange'];
            
            initialCategoriesDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    ${chatCategories.map((category, index) => {
                        const color = colors[index % colors.length];
                        return `
                            <button onclick="selectChatCategory('${category}')" 
                                    class="category-button 
                                           py-2 px-3 text-xs font-medium text-${color}-800 
                                           bg-${color}-50 hover:bg-${color}-200 
                                           border border-${color}-200 rounded-md">
                                ${category}
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Setup chat event listeners
        function setupChatEventListeners() {
            // Enter key to send message
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }

        // Select category from button click (chat)
        async function selectChatCategory(category) {
            selectedCategory = category;
            selectedBrand = ''; // Reset brand selection
            
            // Add user message
            addMessage('You', `I need help with a ${category} product`);
            
            // Get brands for this category
            const categoryBrands = chatBrands.get(category);
            
            if (categoryBrands && categoryBrands.size > 0) {
                const brands = Array.from(categoryBrands).sort();
                const colors = ['blue', 'green', 'purple', 'indigo', 'pink', 'red', 'yellow', 'teal'];
                
                const brandButtons = brands.map((brand, index) => {
                    const color = colors[index % colors.length];
                    return `<button onclick="selectChatBrand('${category}', '${brand}')" 
                                   class="bg-${color}-100 hover:bg-${color}-200 px-3 py-2 rounded-lg text-sm mr-2 mb-2 text-${color}-800 border border-${color}-200 transition-colors">
                               ${brand}
                           </button>`;
                }).join('');

                addMessage('Assistant', `Thanks, I'm happy to help you with your ${category} product. Please select your product's brand, or you can skip this step and ask your question directly:`, 
                    `<div class="mt-3 flex flex-wrap">${brandButtons}</div>`);
            } else {
                addMessage('Assistant', `Thanks, I'm ready to help you with your ${category} product. What specific question or issue can I assist you with?`);
            }
        }

        // Select brand from button click
        function selectChatBrand(category, brand) {
            selectedBrand = brand;
            
            addMessage('You', `The brand of my product is ${brand}`);
            addMessage('Assistant', `Perfect! Please tell me what issue you are experiencing with your ${brand} ${category} product.`);
        }

        // Send message to chatbot
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Enhanced category validation
            if (!selectedCategory) {
                addMessage('Assistant', 'Please first select a product category by clicking one of the buttons above. This helps me provide you with more specific assistance.');
                return;
            }

            // Add user message
            addMessage('You', message);
            userInput.value = '';

            // Add loading message
            const loadingId = addLoadingMessage();

            // Call the real agentic API
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        category: selectedCategory,
                        brand: selectedBrand,
                        product_id: currentProduct ? currentProduct.Product_ID : null
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Remove loading message and add actual response
                removeLoadingMessage(loadingId);
                addMessage('Assistant', data.response);
                
            } catch (error) {
                console.error('Error calling agentic API:', error);
                removeLoadingMessage(loadingId);
                addMessage('System', 'Sorry, I encountered an error connecting to the support system. Please try again.');
            }
        }



        // Add loading message
        function addLoadingMessage() {
            const chat = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            messageDiv.id = loadingId;
            messageDiv.className = 'p-3 rounded-lg bg-gray-100 mr-8';
            messageDiv.innerHTML = `
                <strong class="text-slate-600">Assistant:</strong> 
                <span class="ml-2">Thinking</span>
                <span class="loading-dots ml-1">
                    <span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
                </span>
            `;
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
            return loadingId;
        }

        // Remove loading message
        function removeLoadingMessage(loadingId) {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        // Add message to chat
        function addMessage(sender, message, extraContent = '', extraClass = '') {
            const chat = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            
            let senderClass = '';
            let senderColor = '';
            
            if (sender === 'You') {
                senderClass = 'bg-sky-50 ml-8 border-l-4 border-sky-300';
                senderColor = 'text-sky-600';
            } else if (sender === 'Assistant') {
                senderClass = 'bg-slate-100 mr-8 border-l-4 border-slate-500';
                senderColor = 'text-slate-700';
            } else if (sender === 'System') {
                senderClass = 'bg-red-100 border-l-4 border-red-500';
                senderColor = 'text-red-600';
            }
            
            messageDiv.className = `p-3 rounded-lg ${senderClass} ${extraClass}`;
            
            const formattedMessage = message.replace(/\n/g, '<br>');

            let content = `<strong class="${senderColor}">${sender}:</strong> <span class="mt-1">${formattedMessage}</span>`;
            if (extraContent) {
                content += `<div class="mt-2">${extraContent}</div>`;
            }
            
            messageDiv.innerHTML = content;
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
        }

        // =================== CHAT UI CONTROLS ===================

        // Toggle chat
        function toggleChat() {
            if (isChatOpen) {
                closeChat();
            } else {
                openChat();
            }
        }

        // Open chat
        function openChat() {
            chatOverlay.classList.remove('hidden');
            chatModal.classList.remove('closing');
            chatIcon.classList.add('hidden');
            closeIcon.classList.remove('hidden');
            isChatOpen = true;
            
            // Focus input
            setTimeout(() => {
                userInput.focus();
            }, 300);
        }

        // Close chat
        function closeChat() {
            chatModal.classList.add('closing');
            setTimeout(() => {
                chatOverlay.classList.add('hidden');
                chatModal.classList.remove('closing');
                chatIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
                isChatOpen = false;
            }, 200);
        }

        // Event listeners for storefront
        searchInput.addEventListener('input', filterProducts);
        brandFilter.addEventListener('change', filterProducts);
        categoryFilter.addEventListener('change', filterProducts);
        backBtn.addEventListener('click', goBackToStorefront);

        // Event listeners for chat
        chatToggleBtn.addEventListener('click', toggleChat);
        closeChatBtn.addEventListener('click', closeChat);
        
        // Close chat when clicking outside modal
        chatOverlay.addEventListener('click', (e) => {
            if (e.target === chatOverlay) {
                closeChat();
            }
        });

        // Prevent chat modal from closing when clicking inside it
        chatModal.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
        });
    </script>
</body>
</html>